<!DOCTYPE HTML>
<html>
  <head>
    <script type="text/javascript">
      var default_settings = {
        "Morse Code Phone Message": "KEY53",
        "Penalty Hint": 0,
        "Penalty Alarm Trigger": 5,
        "Alarm Defuse Order": "3421",
        "Alarm Time To Defuse Factor": 12,
        "Alarm Siren Duration": 15,
        "Telephone Exhange Combination": 1044,
        "Morse Code Interpreter Message": "CODEBLUE",
        "Latch Open Close Delay": 1000,
        "Latch Open Close Count": 2,
        "Latch Open Close Count Delay": 800,
        "Door LED Brightness": 100,
        "Door LED Transision Blinks": 4
      }
    </script>
    <script src="jquery-2.1.4.min.js"></script>
    <script src="masonry.pkgd.min.js"></script>
    <title>Locked Room Interface</title>
    <style type="text/css">
      html {
        width: 100%;
        padding: 0;
      }
      body {
        background-color: #505050;
        text-align: center;
        margin: 0;
        width: 100%;
        padding: 0;
      }
      .grid {
        width: 1200px;
        margin: 0 auto;
        padding: 0;
      }
      .grid-item {
        text-align: left;
        width: 330px;
        height: auto;
        margin: 30px 0 0 30px;
        /*display: inline-block;*/
        background-color: #eee;
        margin-bottom: 10px;
        border-radius: 5px;
        padding: 10px;
        /*vertical-align: middle;*/
        /*border: 2px solid black;*/
      }
      h3 {
        color: #000;
        text-align: center
      }
      .stats {
        text-align: center;
        margin-bottom: 15px;
      }
      .stats table {
        margin: 0 auto;
      }
      .stats table:nth-child(1) {
        text-align: right
      }
      .stats table td {
        text-align: left
      }
      #banner table:nth-child(2) {
        text-align: right;
      }
      #banner table td {
        text-align: left;
        padding-left: 10px;
      }
      #banner {
        padding: 10px 0;
        margin: 20px 0;
      }
      button {
        display: inline-block;
      }
      .block {
        text-align: center;
        margin: 5px;
      }
      .led table tr td button {
        width: 60px;
        padding: 5px;
      }

      #banner {
        width: 100%;
        background-color: white;
        position: relative;
        top: 0;
        margin: 0;
      }

      .shrinkToFit {
        border: 1px solid grey;
        padding: 3px;
      }
    </style>
  </head>
  <body>
    <div id="banner">
      <h2 style="margin: 0 0 10px 0">Room Interface</h2>
      <div>
        <span style="font-size: 1.2em">Status:</span><span style="font-size: 1.2em; color: grey" id="serverState">Waiting for server...</span>
        <br>
        <span id="serverTip" style="font-size: 0.9em">If the server doesn't respond after a few seconds, try resetting it.</span>
      </div>
      <hr>
      <div style="text-align: center; font-weight: 700; margin: 0 0 10px 0; font-size: 2em">
      Time: <span id="display_time" style="color: red">00:00</span> + Penalties: <span id="display_penalties">0</span> = Score: <span id="display_score"></span>
      </div>
      <a style="float:left; margin: 0 0 20px 5px; width: 48.5%" href="http://admin:@192.168.2.51/video.cgi">
        <img width="100%" height="auto" src="http://admin:@192.168.2.51/video.cgi" alt="Camera 1 is unavailable" class="shrinkToFit" style="width: 100%; height: auto; display: block">
      </a>
      <a style="float:right; margin: 0 12px 20px 0; width: 48.5%" href="http://admin:@192.168.2.52/video.cgi">
        <img width="100%" height="auto" src="http://admin:@192.168.2.52/video.cgi" alt="Camera 2 is unavailable" class="shrinkToFit" style="width: 100%; height: auto; display: block">
      </a>
      <table style="margin: 20px auto; clear: both;">
        <tr>
          <th style="text-align: right">Secret Cupboard:</th>
          <td><span id="stat_Secret-Cupboard"></span></td>
        </tr>
        <tr>
          <th style="text-align: right">Telephone Exchange:</th>
          <td><span id="stat_Telephone-Exchange-Completed"></span></td>
        </tr>
        <tr>
          <th style="text-align: right">Wooden Box (wall switch):</th>
          <td><span id="stat_Wall-Switch-1"></span></td>
        </tr>
<!--         <tr>
          <th style="text-align: right">Coloured Wires (to enable morse tapper):</th>
          <td><span id="stat_Coloured-Wires-Connected"></span></td>
        </tr> -->
        <tr>
          <th style="text-align: right">Plastic Box (released by transmitting morse code):</th>
          <td><span id="stat_Wall-Switch-2"></span></td>
        </tr>
          <th style="text-align: right">Locker 1 (052):</th>
          <td><span id="stat_Locker-1-Opened"></span></td>
        </tr>
        <tr>
          <th style="text-align: right">Locker 2 (053):</th>
          <td><span id="stat_Locker-2-Opened"></span></td>
        </tr>
        <tr>
          <th style="text-align: right">Locker 3 (054):</th>
          <td><span id="stat_Locker-3-Opened"></span></td>
        </tr>
        <tr>
          <th style="text-align: right">Locker 4 (055):</th>
          <td><span id="stat_Locker-4-Opened"></span></td>
        </tr>
        <tr>
          <th style="text-align: right">Coloured Wires:</th>
          <td><span id="stat_Coloured-Wires"></span></td>
        </tr>
        <tr>
          <th style="text-align: right">Alarm:</th>
          <td><span id="stat_Alarm-Deactivated"></span></td>
        </tr>
      </table>
      <span>Room is <span id="percentComplete">not</span> complete</span>
      <button onclick="resetRoom()">Reset Room</button>
      <hr>
      <span id="codes" style="color: #333; font-size: 0.9em"></span>
      <br><br>
      <span>Last server update: </span><span id="lastUpdate"><b>Never</b></span>
    </div>

  <div class="grid">

      <!-- ****************************************************************** -->
      <!--************************* Morse Code Phone *************************-->
      <!-- ****************************************************************** -->

      <div class="grid-item" id="Morse-Code-Phone">
        <h3>Morse Code Phone</h3>
        <div class="stats"></div>
        <div class="block">
          <button onclick="queue_command(8,'*TRIG')">Trigger</button>
        </div>
        <hr>
        <div class="block">
          <span>New message: </span><input maxlength="20" type="text" id="newMessagePhone" value="KEY53" style="width: 130px">
          <button onclick="updateMessagePhone()">Set</button>
        </div>
        <hr>
        <button onclick="queue_command(8,'*RST')">Reset</button>
      </div>


      <!-- ****************************************************************** -->
      <!--******************************* Clock ******************************-->
      <!-- ****************************************************************** -->
      <div class="grid-item" id="Clock">
        <h3>Clock</h3>
        <div class="stats"></div>
        <hr>
        <div class="block">
          <span>Enter a time: </span><input type="text" id="newTime" value="00:00" style="width: 100px">
          <button onclick="updateTime()">Set</button>
        </div>
        <hr>
        <div class="block">
          <span>Remote Timekeeper: </span><input type="text" id="remoteTime" value="00:00" style="width: 100px">
          <button onclick="syncTime()">Sync</button>
        </div>
        <hr>
        <button onclick="queue_command(4,'*RST')">Reset</button>
      </div>

      <!-- ****************************************************************** -->
      <!-- ************************** Hint Counter ************************** -->
      <!-- ****************************************************************** -->
      <div class="grid-item" id="Hint-Counter">
        <h3>Penalty Counter</h3>
        <div class="stats"></div>
        <hr>
        <div class="block">
          <table style="margin: 0 auto">
            <tr>
              <td style="text-align: right">Hint given cost:</td>
              <td><input maxlength="4" type="text" id="hintGivenCost" value="" style="width: 40px"></td>
              <td><button onclick="updateHintGivenCost()">Set</button></td>
            </tr>
            <tr>
              <td style="text-align: right">Alarm triggered cost:</td>
              <td><input maxlength="3" type="text" id="alarmTriggerCost" value="" style="width: 40px"></td>
              <td><button onclick="updateAlarmTriggerCost()">Set</button></td>
            </tr>
          </table>
        </div>
        <hr>
        <div class="block">
          <span>Set hint count: </span><input maxlength="3" type="text" id="newHintCount" value="" style="width: 40px">
          <button onclick="updateHintCount()">Set</button>
        </div>
        <hr>
        <div class="block">
          <button onclick="queue_command(10, '*DECREMENT')">Decrement hints</button>
          <button onclick="queue_command(10, '*INCREMENT')">Increment hints</button>
        </div>
        <button onclick="queue_command(10,'*RST')">Reset</button>
      </div>

      <!-- ****************************************************************** -->
      <!--******************* Morse Code Interpreter *************************-->
      <!-- ****************************************************************** -->
      <div class="grid-item" id="Morse-Code-Interpreter">
        <h3>Morse Code Interpreter</h3>
        <div class="stats"></div>
        <hr>
        <div class="block">
          <span>New message: </span><input maxlength="20" type="text" id="newMessage" value="CODEBLUE" style="width: 130px">
          <button onclick="updateMessage()">Set</button>
        </div>
        <hr>
        <div class="block">
          <button onclick="queue_command(5, '*TRIG')">Set as done</button>
        </div>
        <hr>
        <button onclick="queue_command(5,'*RST')">Reset</button>
      </div>

      <!-- ****************************************************************** -->
      <!-- **************************** Alarm ******************************* -->
      <!-- ****************************************************************** -->
      <div class="grid-item" id="Alarm">
        <h3>Alarm</h3>
        <div class="stats"></div>
        <hr>
        <div class="block">
          <table style="margin: 0 auto">
            <tr>
              <td style="text-align: right">Defuse order:</td>
              <td><input maxlength="4" type="text" id="newAlarmCombo" value="" style="width: 40px"></td>
              <td><button onclick="updateAlarmCombo()">Set</button></td>
            </tr>
            <tr>
              <td style="text-align: right">Defuse duration factor:</td>
              <td><input maxlength="3" type="text" id="newAlarmDefuseDuration" value="" style="width: 40px"></td>
              <td><button onclick="updateAlarmDefuseDuration()">Set</button></td>
            </tr>
            <tr>
              <td style="text-align: right">Alarm duration (sec):</td>
              <td><input maxlength="2" type="text" id="newAlarmDuration" value="" style="width: 40px"></td>
              <td><button onclick="updateAlarmDuration()">Set</button></td>
            </tr>
          </table>
        </div>
        <hr>
        <div class="block">
          <button onclick="queue_command(11, '*ARM')">Arm</button>
          <button onclick="queue_command(11, '*TRIG')">Trigger</button>
          <button onclick="queue_command(11, '*DEFUSE')">Defuse</button>
        </div>
        <hr>
        <button onclick="queue_command(11,'*RST')">Reset</button>
      </div>


      <!-- ****************************************************************** -->
      <!-- *********************** Telephone Exchange *********************** -->
      <!-- ****************************************************************** -->
      <div class="grid-item" id="Telephone-Exchange">
        <h3>Telephone Exchange</h3>
        <div class="stats"></div>
        <div class="block">
          <button onclick="queue_command(9,'*TRIG')">Trigger</button>
        </div>
        <hr>
        <div class="block">
          <table style="margin: 0 auto">
            <tr>
              <td>
                <label for="6">(6<sub>32</sub>) Berlin</label><input type="checkbox" id="6">
              </td>
              <td style="text-align: left">
                <input type="checkbox" id="7"><label for="7">St. Petersburg (7<sub>64</sub>)</label>
              </td>
            </tr>
            <tr>
              <td>
                <label for="5">(5<sub>16</sub>) London</label><input type="checkbox" id="5">
              </td>
              <td style="text-align: left">
                <input type="checkbox" id="8"><label for="8">Washington (8<sub>128</sub>)</label>
              </td>
            </tr>
            <tr>
              <td>
                <label for="4">(4<sub>8</sub>) Moscow</label><input type="checkbox" id="4">
              </td>
              <td style="text-align: left">
                <input type="checkbox" id="9"><label for="9">Munich (9<sub>256</sub>)</label>
              </td>
            </tr>
            <tr>
              <td>
                <label for="3">(3<sub>4</sub>) Taupo</label><input type="checkbox" id="3">
              </td>
              <td style="text-align: left">
                <input type="checkbox" id="10"><label for="10">Birmingham (10<sub>512</sub>)</label>
              </td>
            </tr>
            <tr>
              <td>
                <label for="2">(2<sub>2</sub>) Prague</label><input type="checkbox" id="2">
              </td>
              <td style="text-align: left">
                <input type="checkbox" id="11"><label for="11">Warsaw (11<sub>1024</sub>)</label>
              </td>
            </tr>
            <tr>
              <td>
                <label for="1">(1<sub>1</sub>) Paris</label><input type="checkbox" id="1">
              </td>
              <td style="text-align: left">
                <input type="checkbox" id="12"><label for="12">Chicago (12<sub>2048</sub>)</label>
              </td>
            </tr>
            </table>
            <button onclick="setCombo()">Set pattern</button>
        </div>

        <hr>
        <button onclick="queue_command(9,'*RST')">Reset</button>
      </div>

      <!-- ****************************************************************** -->
      <!--************************ Locker Door Sensors ***********************-->
      <!-- ****************************************************************** -->

      <div class="grid-item" id="Locker-Door-Sensors">
        <h3>Locker Door Sensors</h3>
        <div class="stats"></div>
        <hr>
        <button onclick="queue_command(2,'*RST')">Reset</button>
      </div>

      <!-- ****************************************************************** -->
      <!-- ************************** Secret Cupboard *********************** -->
      <!-- ****************************************************************** -->

      <div class="grid-item" id="Secret-Cupboard">
        <h3>Secret Cupboard</h3>
        <div class="stats"></div>
        <hr>
        <button onclick="queue_command(7,'*RST')">Reset</button>
      </div>

      <!-- ****************************************************************** -->
      <!-- ************************** Geiger Counter ************************ -->
      <!-- ****************************************************************** -->
  <!--     <div class="grid-item" id="Geiger-Counter">
        <h3>Geiger Counter</h3>
        <div class="stats"></div>
        <hr>
        <button onclick="queue_command(7,'*RST')">Reset</button>
      </div> -->


      <!-- ****************************************************************** -->
      <!--********************** Wall Switch Controller **********************-->
      <!-- ****************************************************************** -->

      <div class="grid-item" id="Wall-Switch-Controller">
        <h3>Wall Switch Controller</h3>
        <div class="stats"></div>
        <div class="block">
          <button onclick="queue_command(6,'*TRIG=2')">Trigger Left</button>
          <button onclick="queue_command(6,'*TRIG=1')">Trigger Right</button>
        </div>
        <hr>
        <button onclick="queue_command(6,'*RST')">Reset</button>
      </div>


      <!-- ****************************************************************** -->
      <!--********************** Coloured Wires Puzzle  **********************-->
      <!-- ****************************************************************** -->

      <div class="grid-item" id="Coloured-Wires">
        <h3>Coloured Wires</h3>
        <div class="stats"></div>
        <hr>
        <button onclick="queue_command(12,'*RST')">Reset</button>
      </div>


      <!-- ****************************************************************** -->
      <!-- *********************** LED Door Controller ********************** -->
      <!-- ****************************************************************** -->

      <div class="grid-item" id="LED-Door-Controller">
        <h3>LED Door Controller</h3>
        <div class="stats"></div>
        <hr>
        <div class="block">
          <table style="margin: 0 auto">
            <tr>
              <td style="text-align: right">Progress (/145 Silent):</td>
              <td><input maxlength="3" type="text" id="ledProgress_silent" value="" style="width: 40px"></td>
              <td><button onclick="set_led_progress(false)">Set</button></td>
            </tr>
            <tr>
              <td style="text-align: right">Progress (/145 Beep):</td>
              <td><input maxlength="3" type="text" id="ledProgress_beep" value="" style="width: 40px"></td>
              <td><button onclick="set_led_progress(true)">Set</button></td>
            </tr>
            <tr>
              <td style="text-align: right">Latch delay (ms):</td>
              <td><input maxlength="4" type="text" id="latch_delay" value="" style="width: 40px"></td>
              <td><button onclick="set_latch_delay()">Set</button></td>
            </tr>
            <tr>
              <td style="text-align: right">Latch count:</td>
              <td><input maxlength="4" type="text" id="latch_count" value="" style="width: 40px"></td>
              <td><button onclick="set_latch_count()">Set</button></td>
            </tr>
            <tr>
              <td style="text-align: right">Inter-Latch delay (ms):</td>
              <td><input maxlength="4" type="text" id="latch_count_delay" value="" style="width: 40px"></td>
              <td><button onclick="set_latch_count_delay()">Set</button></td>
            </tr>
            <tr>
              <td style="text-align: right">Door brightness: (0-255)</td>
              <td><input maxlength="3" type="text" id="led_brightness" value="" style="width: 40px"></td>
              <td><button onclick="set_led_brightness()">Set</button></td>
            </tr>
            <tr>
              <td style="text-align: right">Door transitions (0-255)</td>
              <td><input maxlength="1" type="text" id="led_transitions" value="" style="width: 40px"></td>
              <td><button onclick="set_led_transitions()">Set</button></td>
            </tr>
          </table>
        </div>
        <hr>
        <div class="block">
          Brightness
          <button onclick="queue_command(3,'*BRIGHT=5')">Min</button>
          <button onclick="queue_command(3,'*BRIGHT=100')">Normal</button>
          <button onclick="queue_command(3,'*BRIGHT=255')">Max</button>
        </div>
        <hr>
        <div class="block">
          <button onclick="queue_command(3,'*BLINK=3')">Blink</button>
          <button onclick="queue_command(3,'*TRIG')">Trigger latch</button>
        </div>
        <hr>
        <tr><button onclick="queue_command(3,'*RST')">Reset</button></tr>
      </div>

    </div>


    <script type="text/javascript">

      var actual_settings = {
        "Morse Code Phone Message": -1,
        "Penalty Hint": -1,
        "Penalty Alarm Trigger": -1,
        "Alarm Defuse Order": -1,
        "Alarm Time To Defuse Factor": -1,
        "Alarm Siren Duration": -1,
        "Telephone Exhange Combination": -1,
        "Morse Code Interpreter Message": -1,
        "Latch Open Close Delay": -1,
        "Latch Open Close Count": -1,
        "Latch Open Close Count Delay": -1,
        "Door LED Brightness": -1,
        "Door LED Transision Blinks": -1
      }

      function char_to_morse(character) {
        var c = character.toLowerCase();
        if (c == 'a') return ".-";
        else if (c == 'b') return "-...";
        else if (c == 'c') return "-.-.";
        else if (c == 'd') return "-..";
        else if (c == 'e') return ".";
        else if (c == 'f') return "..-.";
        else if (c == 'g') return "--.";
        else if (c == 'h') return "....";
        else if (c == 'i') return "..";
        else if (c == 'j') return ".---";
        else if (c == 'k') return "-.-";
        else if (c == 'l') return ".-..";
        else if (c == 'm') return "--";
        else if (c == 'n') return "-.";
        else if (c == 'o') return "---";
        else if (c == 'p') return ".--.";
        else if (c == 'q') return "--.-";
        else if (c == 'r') return ".-.";
        else if (c == 's') return "...";
        else if (c == 't') return "-";
        else if (c == 'u') return "..-";
        else if (c == 'v') return "...-";
        else if (c == 'w') return ".--";
        else if (c == 'x') return "-..-";
        else if (c == 'y') return "-.--";
        else if (c == 'z') return "--..";
        else if (c == '1') return ".----";
        else if (c == '2') return "..---";
        else if (c == '3') return "...--";
        else if (c == '4') return "....-";
        else if (c == '5') return ".....";
        else if (c == '6') return "-....";
        else if (c == '7') return "--...";
        else if (c == '8') return "---..";
        else if (c == '9') return "----.";
        else if (c == '0') return "-----";
        else if (c == ' ') return "_";
        else return "?";
      }

      function button_to_city_telex(number) {
        if (number == 1) return "Paris";
        else if (number == 2) return "Prague";
        else if (number == 3) return "Taupo";
        else if (number == 4) return "Moscow";
        else if (number == 5) return "London";
        else if (number == 6) return "Berlin";
        else if (number == 7) return "St. Petersburg";
        else if (number == 8) return "Washington";
        else if (number == 9) return "Munich";
        else if (number == 10) return "Birmingham";
        else if (number == 11) return "Warsaw";
        else if (number == 12) return "Chicago";
      }

      var $grid = $('.grid').masonry({
        itemSelector: '.grid-item',
        columnWidth: 30,
      });
      setTimeout(getStats, 1000);

      var locker_thresholds = [500, 500, 500, 500];

      var messages = {
        "phone": "",
        "interpreter": "",
        "telex": ""
      }

      var alarm_wire_combos = [
        "1234", //0
        "1243", //1
        "1324", //2
        "1342", //3
        "1423", //4
        "1432", //5
        "2134", //6
        "2143", //7
        "2314", //8
        "2341", //9
        "2413", //10
        "2431", //11
        "3124", //12
        "3142", //13
        "3214", //14
        "3241", //15
        "3412", //16
        "3421", //17
        "4123", //18
        "4132", //19
        "4213", //20
        "4231", //21
        "4312", //22
        "4321" //23
      ]

      var triggers = {
        "Secret Cupboard": 0,
        "Telephone Exchange Completed": 0,
        "Wall Switch 1": 0,
        "Wall Switch 2": 0,
        "Locker 1 Opened": 0,
        "Locker 2 Opened": 0,
        "Locker 3 Opened": 0,
        "Locker 4 Opened": 0,
        "Alarm finished": 0,
        "Coloured Wires Connected": 0
      }

      var names = {
        1: "Server",
        2: "Locker Door Sensors",
        3: "LED Door Controller",
        4: "Clock",
        7: "Secret Cupboard",
        5: "Morse Code Interpreter",
        6: "Wall Switch Controller",
        8: "Morse Code Phone",
        9: "Telephone Exchange",
        10: "Hint Counter",
        11: "Alarm",
        12: "Coloured Wires"
      }

      puzzle_data = {}
      var lastUpdate = 0;
      var end_sequence_fired = 0;
      var counter = 0;
      var last_progress = 0;
      var server_state = -1;
      var alarm_finished_type = -1;
      var settings_loaded = 0;
      var message_pending_flag = 0;
      var hints_given = 0;
      var alarm_triggered = 0;
      var hintGivenCost = 0;
      var alarmTriggerCost = 0;
      var timer_lights;
      var latch_count;

      var command_stack = [];


      function sleep(milliseconds) {
        var start = new Date().getTime();
        for (var i = 0; i < 1e7; i++) {
          if ((new Date().getTime() - start) > milliseconds){
            break;
          }
        }
      }

      $("#hintGivenCost").val(default_settings["Penalty Hint"]);
      updateHintGivenCost();

      $("#alarmTriggerCost").val(default_settings["Penalty Alarm Trigger"]);
      updateAlarmTriggerCost();


      function load_defaults() {

        clearTimeout(timer_lights);
        // Turn lights on
        queue_command(3,"*LIGHTS=1");

        if (actual_settings["Morse Code Phone Message"] != default_settings["Morse Code Phone Message"]) {
          $("#newMessagePhone").val(default_settings["Morse Code Phone Message"]);
          updateMessagePhone();
        }

        $("#hintGivenCost").val(default_settings["Penalty Hint"]);
        updateHintGivenCost();

        $("#alarmTriggerCost").val(default_settings["Penalty Alarm Trigger"]);
        updateAlarmTriggerCost();

        if (actual_settings["Alarm Defuse Order"] != default_settings["Alarm Defuse Order"]) {
          $("#newAlarmCombo").val(default_settings["Alarm Defuse Order"]);
          updateAlarmCombo();
        }

        if (actual_settings["Alarm Time To Defuse Factor"] != default_settings["Alarm Time To Defuse Factor"]) {
          $("#newAlarmDefuseDuration").val(default_settings["Alarm Time To Defuse Factor"]);
          updateAlarmDefuseDuration();
        }

        if (actual_settings["Alarm Siren Duration"] != default_settings["Alarm Siren Duration"]) {
          $("#newAlarmDuration").val(default_settings["Alarm Siren Duration"]);
          updateAlarmDuration();
        }

        if (actual_settings["Telephone Exhange Combination"] != default_settings["Telephone Exhange Combination"]) {
          var num = default_settings["Telephone Exhange Combination"];
          for (var i=0; i<12; i++) {
            var id = "#" + (i + 1);
            $(id).prop('checked', (num & (1 << i)) > 0 ? true : false);
          }
          setCombo();
        }

        if (actual_settings["Morse Code Interpreter Message"] != default_settings["Morse Code Interpreter Message"]) {
          $("#newMessage").val(default_settings["Morse Code Interpreter Message"]);
          updateMessage();
        }

        if (actual_settings["Latch Open Close Delay"] != default_settings["Latch Open Close Delay"]) {
          $("#latch_delay").val(default_settings["Latch Open Close Delay"]);
          set_latch_delay();
        }

        if (actual_settings["Latch Open Close Count"] != default_settings["Latch Open Close Count"]) {
          $("#latch_count").val(default_settings["Latch Open Close Count"]);
          set_latch_count();
        }

        if (actual_settings["Latch Open Close Count Delay"] != default_settings["Latch Open Close Count Delay"]) {
          $("#latch_count_delay").val(default_settings["Latch Open Close Count Delay"]);
          set_latch_count_delay();
        }

        updateHintGivenCost();
        updateAlarmTriggerCost();

        if (actual_settings["Door LED Brightness"] != default_settings["Door LED Brightness"]) {
          $("#led_brightness").val(default_settings["Door LED Brightness"]);
          set_led_brightness();
        }

        if (actual_settings["Door LED Transision Blinks"] != default_settings["Door LED Transision Blinks"]) {
          $("#led_transitions").val(default_settings["Door LED Transision Blinks"]);
          set_led_transitions();
        }

        // Hack to force phone to reset correctly.
        queue_command(8,"*RST");

        end_sequence_fired = 0;
        settings_loaded = 1;
      }

      function getStats() {
        counter++;
        $.ajax({
          url: "http://192.168.2.177?device="+0+"&command=*STAT?",
          datatype: 'json',
          error: function (jqXHR, status) {
            $("#serverState").html("CAN&rsquo;T COMMUNICATE WITH SERVER!");
            $("#serverState").css("font-weight", 700);
            $("#serverState").css("color", 'red');
            $("#serverTip").html("Is it turned on? If it is, you may need to reset it using the key.");
            if (lastUpdate == 0) {
              $("#lastUpdate").html("<b>Never</b>");
            }
            else {
              var now = new Date();
              $("#lastUpdate").html("<b>"+Math.round((now.getTime() - lastUpdate.getTime())/1000)+" seconds ago</b>");
            }
            setTimeout(getStats, 1000);
          },
          timeout: 10000,
          complete: function (jqXHR, status) {
            if (status == "parsererror") {
              $("#serverState").html("CAN&rsquo;T INTERPRET SERVERS RESPONSE!");
              $("#serverState").css("font-weight", 700);
              $("#serverState").css("color", 'red');
              $("#serverTip").html("It is likely that a puzzle is having trouble");
              if (lastUpdate == 0) {
                $("#lastUpdate").html("<b>Never</b>");
              }
              else {
                var now = new Date();
                $("#lastUpdate").html("<b>"+Math.round((now.getTime() - lastUpdate.getTime())/1000)+" seconds ago</b>");
              }
            }
            tick_event();
          },
          success: function (data, status) {
            lastUpdate = new Date();
            $("#lastUpdate").html("Within the last second");
            $("#serverState").css("font-weight", "normal");
            $.each( data, function( key, val ) {
              puzzle_data[names[key]] = val.split(",");
            });
            updateStats();

            var progress = 0;
            var total = 145;
            var steps = 0;
            for (key in triggers) steps++;

            for(var key in triggers) {
              if (triggers[key] == 1) progress++;
            }
            if (triggers["Alarm finished"] == 0) {
              if ((server_state == 1) && (progress != last_progress)) {
                var led_out = Math.round((total/steps) * progress);
                if (led_out > total) led_out = total;
                queue_command(3, "*AUDIO_PROG="+led_out);
                last_progress = progress;
              }
            }
            else {
              if (end_sequence_fired == 0) {
                queue_command(3, "*BRIGHT=255");
                console.log("end");
                if (alarm_finished_type == 1) {
                  // Alarm defused
                  queue_command(3, "*TRANS_BLINKS=0");
                  queue_command(3, "*PROG=145");
                  console.log(actual_settings["Latch Open Close Count"]);
                  console.log(actual_settings["Latch Open Close Count Delay"]);
                  for (var i = 0; i < actual_settings["Latch Open Close Count"]; i++) {
                    console.log(3000 + actual_settings["Latch Open Close Count Delay"] * i);
                    setTimeout(function() { queue_command(3, "*TRIG"); }, 3000 + i * actual_settings["Latch Open Close Count Delay"]);
                  }
                }
                else {
                  // Alarm triggered
                  queue_command(3, "*TRANS_BLINKS=0");
                  queue_command(3, "*PROG=0");
                }
                queue_command(3, "*LIGHTS=0");

                // Turn the lights back on
                timer_lights = setTimeout( function() { queue_command(3, "*LIGHTS=1"); }, 20000);
                end_sequence_fired = 1;
              }
            }
            $("#percentComplete").html(progress + "/"+steps+" (" + Math.round((progress/steps) * 100) + " %)");

            if (server_state == 0 && settings_loaded == 0) load_defaults();
            else if (server_state != 0) settings_loaded = 0;
          }
        });

      }

      function queue_command(device_id, command) {
        command_stack.push({"id": device_id, "command": command});
      }

      function tick_event() {
        if (command_stack.length == 0) getStats();
        else {
          var command = command_stack.shift();
          sendMessage_ticked(command["id"], command["command"]);
        }
      }


      function updateStats() {

        $.each(puzzle_data["Server"], function (key, val) {
          d = val.split(":");
          var g = $("#serverState");
          var e = $("#serverTip");

          switch (d[1]) {
            case "0":
              // STATE_PRE_RUN
              g.html("Ready");
              g.css("color", "blue");
              e.html("Click the button to start the room");
              server_state = 0;
              break;

            case "1":
              // STATE_RUNNING
              g.html("In progress");
              g.css("color", "green");
              e.html("The puzzles are doing their thing...");
              server_state = 1;
              break;

            case "3":
              // STATE_ENDED
              g.html("Finished");
              g.css("color", "black");
              e.html("The players have completed the room (hold the button for 3 secs to reset)");
              server_state = 3;
              break;

            case "4":
              //STATE_RESET
              g.html("Resetting");
              g.css("color", "grey");
              e.html("The puzzles are resetting...");
              server_state = 4;
              break;
          }
        });

        var html = "";
        var table = "<table>";
        $.each(puzzle_data["LED Door Controller"], function (key, val) {
          d = val.split("=");
          switch (d[0]) {
            case "TRANS":
              if (d[1] == "0") {
                html += "<button onclick=\"queue_command(3,'*TRANS=1')\">Enable Transitions</button>";
                table += "<tr><th>Transitions:</th><td>Disabled</td></tr>";
              }
              else {
                html +="<button onclick=\"queue_command(3,'*TRANS=0')\">Disable Transitions</button>";
                table += "<tr><th>Transitions:</th><td>Enabled</td></tr>";
              }
              break;

            case "PROG":
              if (d[1] == -1) {
                html += "<button onclick=\"queue_command(3,'*PROG=0')\">Door on</button>";
                table += "<tr><th>Door LEDs:</th><td>Off</td></tr>";
                table += "<tr><th>Progress:</th><td>N/A</td></tr>";
              }
              else {
                html += "<button onclick=\"queue_command(3,'*PROG=-1')\">Door off</button>";
                table += "<tr><th>Door LEDs:</th><td>On</td></tr>";
                table += "<tr><th>Progress:</th><td>"+d[1]+"/145 ("+Math.floor(((145-d[1])/145)*100)+"%)</td></tr>";
                leds_green = parseInt(d[1]);
              }
              break;

            case "TIME":
              table += "<tr><th>Run time:</th><td>"+d[1]+"</td></tr>";
              break;

            case "BLINKS":
              table += "<tr><th>Transition Blinks:</th><td>"+d[1]+"</td></th>";
              break;

            case "LIGHTS":
              table += "<tr>";
              table += "<th>Main Lights:</th>";
              if (d[1] == 1) {
                table += "<td>On</td>"
                html += "<button onclick=\"queue_command(3,'*LIGHTS=0')\">Lights - OFF</button>";
              }
              else {
                table += "<td>Off</td>" 
                html += "<button onclick=\"queue_command(3,'*LIGHTS=1')\">Lights - ON</button>";
              }
              table += "</tr>";

              break;

            case "LATCH_MS":
              table += "<tr>";
              table += "<th>Latch delay:</th>";
              table += "<td>";
              table += d[1] + " (ms)";
              table += "</td>";
              actual_settings["Latch Open Close Delay"] = parseInt(d[1]);
              break;
          }
          // table += "<tr><th>" + d[0] + ":</th><td>" + d[1] + "</td></tr>";
          // html += d[0] + d[1] + "<br>";
        });
        table += "</table>";
        $("#LED-Door-Controller .stats").html(table+html);


        html = "";
        table = "<table>";
        $.each(puzzle_data["Secret Cupboard"], function (key, val) {
          d = val.split("=");
          switch (d[0]) {
            case "TIME":
              table += "<tr><th>Time:</th><td>"+d[1]+"</td></tr>";
              var timestring = d[1];
              var parts = timestring.split(":");
              var mins = parseInt(parts[1]);
              var hours = parseInt(parts[0]);
              var secs = parseInt(parts[2]);
              mins += hours * 60;
              if (secs < 10) $("#remoteTime").val(mins + ":0" + secs);
              else $("#remoteTime").val(mins + ":" + secs);
              break;

            case "DOOR_OPEN":
              if (d[1] == 1) {
                table += "<tr><th>Secret cupboard:</th><td style=\"color: red\">Open</td></tr>";
              }
              else {
                table += "<tr><th>Secret cupboard:</th><td style=\"color: green\">Closed</td></tr>";
              }
              break;

            case "DOOR_OPENED":
              if (d[1] == 1) {
                triggers["Secret Cupboard"] = 1;
                table += "<tr><th>Secret cupboard found:</th><td style=\"color: red\">Yes</td></tr>";
              }
              else {
                triggers["Secret Cupboard"] = 0;
                table += "<tr><th>Secret cupboard found:</th><td style=\"color: green\">No</td></tr>";
              }
              break;
          }
          // html += d[0] + d[1] + "<br>";
        });
        table += "</table>";
        $("#Secret-Cupboard .stats").html(table+html);

        html = "";
        table = "<table>";
        $.each(puzzle_data["Locker Door Sensors"], function (key, val) {
          d = val.split("=");
          
          switch(d[0]) {
            case "L1":
              if (d[1] & 1) {
                table += "<tr><th>Locker 1 state:</th><td style=\"color: red\">Open</td></tr>";
              }
              else {
                table += "<tr><th>Locker 1 state:</th><td style=\"color: green\">Closed</td></tr>";
              }
              if (d[1] & 2) {
                triggers["Locker 1 Opened"] = 1;
                table += "<tr><th>Locker 1 opened:</th><td style=\"color: red\">Yes</td></tr>";
              }
              else {
                triggers["Locker 1 Opened"] = 0;
                table += "<tr><th>Locker 1 opened:</th><td style=\"color: green\">No</td></tr>";
              }
              break;

            case "L2":
              if (d[1] & 1) {
                table += "<tr><th>Locker 2 state:</th><td style=\"color: red\">Open</td></tr>";
              }
              else {
                table += "<tr><th>Locker 2 state:</th><td style=\"color: green\">Closed</td></tr>";
              }
              if (d[1] & 2) {
                triggers["Locker 2 Opened"] = 1;
                table += "<tr><th>Locker 2 opened:</th><td style=\"color: red\">Yes</td></tr>";
              }
              else {
                triggers["Locker 2 Opened"] = 0;
                table += "<tr><th>Locker 2 opened:</th><td style=\"color: green\">No</td></tr>";
              }
              break;

            case "L3":
              if (d[1] & 1) {
                table += "<tr><th>Locker 3 state:</th><td style=\"color: red\">Open</td></tr>";
              }
              else {
                table += "<tr><th>Locker 3 state:</th><td style=\"color: green\">Closed</td></tr>";
              }
              if (d[1] & 2) {
                triggers["Locker 3 Opened"] = 1;
                table += "<tr><th>Locker 3 opened:</th><td style=\"color: red\">Yes</td></tr>";
              }
              else {
                triggers["Locker 3 Opened"] = 0;
                table += "<tr><th>Locker 3 opened:</th><td style=\"color: green\">No</td></tr>";
              }
              break;

            case "L4":
              if (d[1] & 1) {
                table += "<tr><th>Locker 4 state:</th><td style=\"color: red\">Open</td></tr>";
              }
              else {
                table += "<tr><th>Locker 4 state:</th><td style=\"color: green\">Closed</td></tr>";
              }
              if (d[1] & 2) {
                triggers["Locker 4 Opened"] = 1;
                table += "<tr><th>Locker 4 opened:</th><td style=\"color: red\">Yes</td></tr>";
              }
              else {
                triggers["Locker 4 Opened"] = 0;
                table += "<tr><th>Locker 4 opened:</th><td style=\"color: green\">No</td></tr>";
              }
              break;
          }
          // html += d[0] + d[1] + "<br>";
        });
        table += "</table>";
        $("#Locker-Door-Sensors .stats").html(table+html);

        html = "";
        table = "<table>";
        $.each(puzzle_data["Clock"], function (key, val) {
          d = val.split("=");
          switch (d[0]) {
            case "TIME":
              table += "<tr><th>Time:</th><td>"+d[1]+"</td></tr>";
              mins = parseInt(d[1].split(":")[0]);
              penalties = (hints_given * hintGivenCost) + (alarm_triggered * alarmTriggerCost);
              secs = parseInt(d[1].split(":")[1]);
              $("#display_time").html(d[1]);
              $("#display_penalties").html(penalties);
              if (secs < 10) $("#display_score").html((mins + penalties) + ":0" + secs);
              else $("#display_score").html((mins + penalties) + ":" + secs);
              break;

            case "PAUSED":
              if (d[1]==1) {
                table += "<tr><th>State:</th><td>Paused</td></tr>";
                html +="<button onclick=\"queue_command(4,'*PAUSE=0')\">Start</button>";
              }
              else {
                table += "<tr><th>State:</th><td>Running</td></tr>";
                html +="<button onclick=\"queue_command(4,'*PAUSE=1')\">Pause</button>";
              }

              break;
          }
          // html += d[0] + d[1] + "<br>";
        });
        table += "</table>";
        $("#Clock .stats").html(table+html);

        html = "";
        table = "<table>";
        $.each(puzzle_data["Morse Code Interpreter"], function (key, val) {
          d = val.split("=");
          switch (d[0]) {
            case "TIME":
              table += "<tr><th>Run time:</th><td>"+d[1]+"</td></tr>";
              break;

            case "DONE":
              if (d[1]==1) {
                table += "<tr><th>Completed:</th><td style='color: red'>Yes</td></tr>";
              }
              else {
                table += "<tr><th>Completed:</th><td style='color: green'>No</td></tr>";
              }
              break;

            case "PRESSED":
              if (d[1] == 1) {
                table += "<tr><th>Pressed:</th><td style='color: red'>Yes</td></tr>";
              }
              else {
                table += "<tr><th>Pressed:</th><td style='color: green'>No</td></tr>";
              }
              break;

            case "ATTEMPTS":
              table += "<tr><th>Failed Attempts:</th><td>"+d[1]+"</td></tr>";
              break;

            case "MSG":
              // table += "<tr><th>Target Message:</th><td>"+d[1]+"</td></tr>";
              var target_string = "";
              var string_length = d[1].length;
              var pattern = "";
              var table_tmp = "";
              messages["interpreter"] = d[1];
              actual_settings["Morse Code Interpreter Message"] = d[1];
              for (var i=0; i < string_length; i++) {
                pattern = char_to_morse(d[1].charAt(i));
                target_string = target_string.concat(pattern);
                target_string = target_string.concat("|");
                table_tmp += "<tr><td>" + d[1].charAt(i) + "</td>&nbsp;<td>" + char_to_morse(d[1].charAt(i)) + "</td></tr>";
              }
              
              // table += "<tr><th>Target Pattern:</th><td style='font-size: 1em; font-family: monospace'>"+target_string+"</td></tr>";
              table += "<tr><th>Target:</th><td style='font-size: 1.5em; font-family: monospace'><table>"+table_tmp+"</table></td></tr>";
              break;

            case "TARG":
              table += "<tr><th>Target Pattern:</th><td style='font-size: 2em'>"+d[1]+"</td></tr>";
              break;

            case "LAST":
              if (d[1] != "") table += "<tr><th>Previous Attempt:</th><td style='font-size: 2em'>"+d[1]+"</td></tr>";
              break;
          }
          // html += d[0] + d[1] + "<br>";
        });
        table += "</table>";
        $("#Morse-Code-Interpreter .stats").html(table+html);

        html = "";
        table = "<table>";
        $.each(puzzle_data["Wall Switch Controller"], function (key, val) {
          d = val.split("=");
          switch (d[0]) {
            case "TIME":
              table += "<tr><th>Run time:</th><td>"+d[1]+"</td></tr>";
              break;

            case "SOLENOID_1":
              if (d[1] > 0) {
                table += "<tr><th>Left solenoid:</th><td style='color: red'>Fired " + (d[1] > 1 ? d[1] + ' times' : '') + "</td></tr>";
              }
              else table += "<tr><th>Left solenoid:</th><td style='color: green'>Ready</td></tr>";
              break;

            case "DOOR_1":
              if (d[1] == 1) {
                table += "<tr><th>Left door:</th><td style='color: green'>Closed</td></tr>";
                triggers["Wall Switch 1"] = 0;
              }
              else {
                table += "<tr><th>Left door:</th><td style='color: red'>Open</td></tr>";
                triggers["Wall Switch 1"] = 1;
              }
              break;

            case "SWITCH_1":
              if (d[1] == 1) table += "<tr><th>Left wall switch:</th><td style='color: red'>Enabled</td></tr>";
              else table += "<tr><th>Left wall switch:</th><td style='color: green'>Ready</td></tr>";
              break;

            case "SOLENOID_2":
              if (d[1] > 0) table += "<tr><th>Right solenoid:</th><td style='color: red'>Fired " + (d[1] > 1 ? d[1] + ' times' : '') + "</td></tr>";
              else table += "<tr><th>Right solenoid:</th><td style='color: green'>Ready</td></tr>";
              break;

            case "DOOR_2":
              if (d[1] == 1) {
                table += "<tr><th>Right door:</th><td style='color: green'>Closed</td></tr>";
                triggers["Wall Switch 2"] = 0;
              }
              else {
                table += "<tr><th>Right door:</th><td style='color: red'>Open</td></tr>";
                triggers["Wall Switch 2"] = 1;
              }
              break;

            case "SWITCH_2":
              if (d[1] == 1) table += "<tr><th>Right wall switch:</th><td style='color: red'>Enabled</td></tr>";
              else table += "<tr><th>Right wall switch:</th><td style='color: green'>Ready</td></tr>";
              break;
          }
          // html += d[0] + d[1] + "<br>";
        });
        table += "</table>";
        $("#Wall-Switch-Controller .stats").html(table+html);

        html = "";
        table = "<table>";
        $.each(puzzle_data["Morse Code Phone"], function (key, val) {
          d = val.split("=");
          switch (d[0]) {
            case "TIME":
              table += "<tr><th>Run time:</th><td>"+d[1]+"</td></tr>";
              break;

            case "RUN":
              if (d[1] == 1) table += "<tr><th>Executing:</th><td style='color: yes'>Yes</td></tr>";
              else table += "<tr><th>Executing:</th><td style='color: green'>No</td></tr>";
              break;

            case "HOOK":
              if (d[1] == 1) table += "<tr><th>Receiver on hook:</th><td style='color: green'>Yes</td></tr>";
              else table += "<tr><th>Receiver on hook:</th><td style='color: red'>No</td></tr>";
              break;

            case "RING":
              if (d[1] == 1) table += "<tr><th>Ringing:</th><td style='color: red'>Yes</td></tr>";
              else table += "<tr><th>Ringing:</th><td style='color: green'>No</td></tr>";
              break;

            case "MSG":
              // table += "<tr><th>Message:</th><td>"+d[1]+"</td></tr>";
              // messages["phone"] = d[1];
              var target_string = "";
              var string_length = d[1].length;
              var pattern = "";
              var table_tmp = "";
              actual_settings["Morse Code Phone Message"] = d[1];
              messages["phone"] = d[1];
              for (var i=0; i < string_length; i++) {
                pattern = char_to_morse(d[1].charAt(i));
                target_string = target_string.concat(pattern);
                target_string = target_string.concat("|");
                table_tmp += "<tr><td>" + d[1].charAt(i) + "</td>&nbsp;<td>" + char_to_morse(d[1].charAt(i)) + "</td></tr>";
              }
              
              // table += "<tr><th>Target Pattern:</th><td style='font-size: 1em; font-family: monospace'>"+target_string+"</td></tr>";
              table += "<tr><th>Message:</th><td style='font-size: 1.5em; font-family: monospace'><table>"+table_tmp+"</table></td></tr>";
              break;

            case "PLAYED":
              table += "<tr><th>Message play count:</th><td>"+d[1]+"</td></tr>";
              break;

          }
          // html += d[0] + d[1] + "<br>";
        });
        table += "</table>";
        $("#Morse-Code-Phone .stats").html(table+html);


        html = "";
        table = "<table>";
        $.each(puzzle_data["Telephone Exchange"], function (key, val) {
          d = val.split("=");
          switch (d[0]) {
            case "TIME":
              table += "<tr><th>Run time:</th><td>"+d[1]+"</td></tr>";
              break;

            case "TRIGGERED":
              if (d[1] == 0) {
                table += "<tr><th>Solved:</th><td style='color: green'>No</td></tr>";
                triggers["Telephone Exchange Completed"] = 0;
              }
              else {
                table += "<tr><th>Solved:</th><td style='color: red'>Yes</td></tr>";
                triggers["Telephone Exchange Completed"] = 1;
              }
              break;

            case "COMBO":
              var state = [];
              if (d[1] & 1) state.push(1);
              if (d[1] & 2) state.push(2);
              if (d[1] & 4) state.push(3);
              if (d[1] & 8) state.push(4);
              if (d[1] & 16) state.push(5);
              if (d[1] & 32) state.push(6);
              if (d[1] & 64) state.push(7);
              if (d[1] & 128) state.push(8);
              if (d[1] & 256) state.push(9);
              if (d[1] & 512) state.push(10);
              if (d[1] & 1024) state.push(11);
              if (d[1] & 2048) state.push(12);
              table += "<tr><th>Combination:</th><td>";
              actual_settings["Telephone Exhange Combination"] = d[1];
              messages["telex"] = "";
              $.each(state, function(key, val)  {
                table += button_to_city_telex(val);
                messages["telex"] += button_to_city_telex(val);
                if (key != state.length - 1) {
                  table += " +<br>";
                  messages["telex"] += "+";
                }
              })
              table += "</td></tr>";
              break;

            case "STATE":
              var state = [];
              if (d[1] & 1) state.push(1);
              if (d[1] & 2) state.push(2);
              if (d[1] & 4) state.push(3);
              if (d[1] & 8) state.push(4);
              if (d[1] & 16) state.push(5);
              if (d[1] & 32) state.push(6);
              if (d[1] & 64) state.push(7);
              if (d[1] & 128) state.push(8);
              if (d[1] & 256) state.push(9);
              if (d[1] & 512) state.push(10);
              if (d[1] & 1024) state.push(11);
              if (d[1] & 2048) state.push(12);
              table += "<tr><th>Buttons pressed:</th><td>";
              $.each(state, function(key, val)  {
                table += button_to_city_telex(val);
                if (key != state.length - 1) table += " +<br>";
              })
              table += "</td></tr>";
              break;
          }
          // html += d[0] + d[1] + "<br>";
        });
        table += "</table>";
        $("#Telephone-Exchange .stats").html(table+html);


        html = "";
        table = "<table>";
        $.each(puzzle_data["Hint Counter"], function (key, val) {
          d = val.split("=");
          switch (d[0]) {
            case "HINT_COUNT":
              table += "<tr>";
              table += "<th>Hints given: </th>";
              if (d[1] == 0) {
                table += "<td style='color: green'>None</td>";
              }
              else {
                table += "<td style=\"color: red; font-weight: 700\">" + d[1] + "</td>";
              }
              hints_given = parseInt(d[1]);
              table += "</tr>";

              table += "<tr>";
              table += "<th>Alarm triggered: </th>";
              
              if (triggers["Alarm Finished"] == 1 && alarm_finished_type == 1) {
                table += "<td style=\"color: red\">Yes</td>";
              }
              else table += "<td style=\"color: green\">No</td>";
              table += "</tr>";
            break;
          }
          // html += d[0] + d[1] + "<br>";
        });
        table += "</table>";
        $("#Hint-Counter .stats").html(table+html);

        html = "";
        table = "<table>";
        $.each(puzzle_data["Coloured Wires"], function (key, val) {
          d = val.split("=");
          switch (d[0]) {
            case "WIRES":
              
              table += "<tr>";
              table += "<th>Yellow:</th>";
              if (d[1] & 1) table += "<td style=\"color: red\">Connected</td>";
              else table += "<td style=\"color: green;\">Disconnected</td>";
              table += "</tr>";

              table += "<tr>";
              table += "<th>Green:</th>";
              if (d[1] & 2) table += "<td style=\"color: red\">Connected</td>";
              else table += "<td style=\"color: green;\">Disconnected</td>";
              table += "</tr>";

              table += "<tr>";
              table += "<th>Black:</th>";
              if (d[1] & 4) table += "<td style=\"color: red\">Connected</td>";
              else table += "<td style=\"color: green;\">Disconnected</td>";
              table += "</tr>";

              table += "<tr>";
              table += "<th>Red:</th>";
              if (d[1] & 8) table += "<td style=\"color: red\">Connected</td>";
              else table += "<td style=\"color: green;\">Disconnected</td>";
              table += "</tr>";
            break;

            case "OUTPUT":
              table += "<tr>";
              table += "<th>State:</th>";
              if (d[1] == 1) {
                table += "<td>Morse enabled</td>";
                triggers["Coloured Wires Connected"] = 1;
              }
              else {
                table += "<td>Morse disabled</td>";
                triggers["Coloured Wires Connected"] = 0;
              }
              table += "</tr>";
              

          }
          // html += d[0] + d[1] + "<br>";
        });
        table += "</table>";
        $("#Coloured-Wires .stats").html(table+html);

        html = "";
        table = "<table>";
        $.each(puzzle_data["Alarm"], function (key, val) {
          d = val.split("=");
          switch (d[0]) {
            case "TIME":
              table += "<tr><th>Run time:</th><td>"+d[1]+"</td></tr>";
              break;

            case "COMBO":
              table += "<tr><th>Defuse order:</th>";
              table += "<td>";
              if (d[1] < alarm_wire_combos.length) {
                table += alarm_wire_combos[d[1]][0];
                table += ",";
                table += alarm_wire_combos[d[1]][1];
                table += ",";
                table += alarm_wire_combos[d[1]][2];
                table += ",";
                table += alarm_wire_combos[d[1]][3];
              }
              else table += "Unknown";
              actual_settings["Alarm Defuse Order"] = d[1];
              table += "</td>";                
              table += "</tr>";
              
              break;

            case "STATE":
              table += "<tr><th>Alarm state:</th>";
              if (d[1] == 0) {
                table += "<td style=\"color: black\">";
                table += "Disabled";
                table += "</td>";
                triggers["Alarm finished"] = 1;
                alarm_finished_type = 1;
                alarm_triggered = 0;
              }
              else if(d[1] == 1) {
                table += "<td style=\"color: green\">";
                table += "Ready";
                table += "</td>";
                triggers["Alarm finished"] = 0;
                alarm_finished_type = -1;
                alarm_triggered = 0;
              }
              else if(d[1] == 2) {
                table += "<td style=\"color: blue\">";
                table += "Armed";
                table += "</td>";
                triggers["Alarm finished"] = 0;
                alarm_finished_type = -1;
                alarm_triggered = 0;
              }
              else if(d[1] == 3) {
                table += "<td style=\"color: red\">";
                table += "Triggered";
                table += "</td>";
                triggers["Alarm finished"] = 1;
                alarm_finished_type = 0;
                alarm_triggered = 1;
              }
              table += "</tr>";
            break;

            case "WIRES":
              table += "<tr><th>Wires disconnected:</th><td>";
              var count = 0;
              if (d[1] == 0) table += "None";
              else {
                if (d[1] & 1 == 1) {
                  table += "1";
                  count++;
                }
                if (d[1] & 2 == 1) {
                  if (count > 0) table += ",";
                  table += "2";
                  count++;
                }
                if (d[1] & 4 == 1) {
                  if (count > 0) table += ",";
                  table += "3";
                  count++;
                }
                if (d[1] & 8 == 1) {
                  if (count > 0) table += ",";
                  table += "4";
                  count++;
                }
              }
              table += "</td></tr>";
              
            break;

            case "TFACTOR":
              actual_settings["Alarm Time To Defuse Factor"] = d[1];
              table += "<tr><th>Defuse duration factor:</th><td>"+d[1]+"</td></tr>";
              break;

            case "SIREN_T":
              actual_settings["Alarm Siren Duration"] = d[1];
              table += "<tr>";
              table += "<th>Siren duration:</th>";
              table += "<td>" + d[1] + " (sec)</td>";
              table += "</tr>";
              break;

          }
          // html += d[0] + d[1] + "<br>";
        });
        table += "</table>";
        $("#Alarm .stats").html(table+html);

        if (triggers["Secret Cupboard"]) {
          $("#stat_Secret-Cupboard").html("Found");
          $("#stat_Secret-Cupboard").css("color", "red");
        }
        else {
          $("#stat_Secret-Cupboard").html("Ready");
          $("#stat_Secret-Cupboard").css("color", "green");
        }

        if (triggers["Telephone Exchange Completed"]) {
          $("#stat_Telephone-Exchange-Completed").html("Completed");
          $("#stat_Telephone-Exchange-Completed").css("color", "red");
        }
        else {
          $("#stat_Telephone-Exchange-Completed").html("Ready");
          $("#stat_Telephone-Exchange-Completed").css("color", "green");
        }

        if (triggers["Wall Switch 1"]) {
          $("#stat_Wall-Switch-1").html("Released");
          $("#stat_Wall-Switch-1").css("color", "red");
        }
        else {
          $("#stat_Wall-Switch-1").html("Ready");
          $("#stat_Wall-Switch-1").css("color", "green");
        }

        if (triggers["Wall Switch 2"]) {
          $("#stat_Wall-Switch-2").html("Released");
          $("#stat_Wall-Switch-2").css("color", "red");
        }
        else {
          $("#stat_Wall-Switch-2").html("Ready");
          $("#stat_Wall-Switch-2").css("color", "green");
        }

        // if (triggers["Coloured Wires Connected"]) {
        //   $("#stat_Coloured-Wires-Connected").html("Enabled");
        //   $("#stat_Coloured-Wires-Connected").css("color", "red");
        // }
        // else {
        //   $("#stat_Coloured-Wires-Connected").html("Not pressed");
        //   $("#stat_Coloured-Wires-Connected").css("color", "green");
        // }

        if (triggers["Locker 1 Opened"]) {
          $("#stat_Locker-1-Opened").html("Open");
          $("#stat_Locker-1-Opened").css("color", "red");
        }
        else {
          $("#stat_Locker-1-Opened").html("Ready");
          $("#stat_Locker-1-Opened").css("color", "green");
        }

        if (triggers["Locker 2 Opened"]) {
          $("#stat_Locker-2-Opened").html("Open");
          $("#stat_Locker-2-Opened").css("color", "red");
        }
        else {
          $("#stat_Locker-2-Opened").html("Ready");
          $("#stat_Locker-2-Opened").css("color", "green");
        }

        if (triggers["Locker 3 Opened"]) {
          $("#stat_Locker-3-Opened").html("Open");
          $("#stat_Locker-3-Opened").css("color", "red");
        }
        else {
          $("#stat_Locker-3-Opened").html("Ready");
          $("#stat_Locker-3-Opened").css("color", "green");
        }

        if (triggers["Locker 4 Opened"]) {
          $("#stat_Locker-4-Opened").html("Open");
          $("#stat_Locker-4-Opened").css("color", "red");
        }
        else {
          $("#stat_Locker-4-Opened").html("Ready");
          $("#stat_Locker-4-Opened").css("color", "green");
        }

        if (triggers["Alarm finished"]) {
          if (alarm_finished_type == 1) {
            $("#stat_Alarm-Deactivated").html("Defused");
          }
          else {
            $("#stat_Alarm-Deactivated").html("Triggered");
          }
          $("#stat_Alarm-Deactivated").css("color", "red");
        }
        else {
          $("#stat_Alarm-Deactivated").html("Ready");
          $("#stat_Alarm-Deactivated").css("color", "green");
        }


        if (triggers["Coloured Wires Connected"]) {
          $("#stat_Coloured-Wires").html("Completed");
          $("#stat_Coloured-Wires").css("color", "red");
        }
        else {
          $("#stat_Coloured-Wires").html("Ready");
          $("#stat_Coloured-Wires").css("color", "green");
        }

        $("#codes").html("<span>Phone message: <b>" + messages["phone"] + "</b></span>; <span>Morse interpreter message: <b>" + messages["interpreter"] + "</b></span>; <span>Telex combination: <b>" + messages["telex"] + "</b></span>");

        $grid.masonry('layout');
      }

      function sendMessage(id, msg) {
        message_pending_flag = 1;
        $.ajax({
          url: "http://192.168.2.177?device="+id+"&command="+msg,
          datatype: 'json',
          type: 'GET',
          timeout: 1000,
          complete: function (data) {
            message_pending_flag = 0;
          }
        });
      }

      function sendMessage_ticked(id, msg) {
        message_pending_flag = 1;
        $.ajax({
          url: "http://192.168.2.177?device="+id+"&command="+msg,
          datatype: 'json',
          type: 'GET',
          timeout: 1000,
          complete: function (data) {
            message_pending_flag = 0;
            tick_event();
          }
        });
      }

      function updateTime() {
        val = $("#newTime").val();
        queue_command(4,'*TIME='+val);
      }

      function syncTime() {
        val = $("#remoteTime").val();
        queue_command(4,'*TIME='+val);
      }

      function updateMessage() {
        val = $("#newMessage").val();
        queue_command(5,'*MSG='+val);
      }

      function updateMessagePhone() {
        val = $("#newMessagePhone").val();
        queue_command(8,'*MSG='+val);
      }

      function updateHintCount() {
        val = parseInt($("#newHintCount").val());
        if (val >= 0 && val < 999) {
          queue_command(10,'*HINT_COUNT=' + val)
        }
        else alert("Error interpreting hint count");        
      }


      function setCombo() {
        var combo = 0;
        if ($('#1')[0].checked) combo += 1;
        if ($('#2')[0].checked) combo += 2;
        if ($('#3')[0].checked) combo += 4;
        if ($('#4')[0].checked) combo += 8;
        if ($('#5')[0].checked) combo += 16;
        if ($('#6')[0].checked) combo += 32;
        if ($('#7')[0].checked) combo += 64;
        if ($('#8')[0].checked) combo += 128;
        if ($('#9')[0].checked) combo += 256;
        if ($('#10')[0].checked) combo += 512;
        if ($('#11')[0].checked) combo += 1024;
        if ($('#12')[0].checked) combo += 2048;
        queue_command(9,'*COMBO='+combo)
      }

      function updateAlarmCombo() {
        var combo = -1;
        for (var i = 0; i < alarm_wire_combos.length; i++) {
          if (alarm_wire_combos[i] == $("#newAlarmCombo").val()) combo = i;
        }
        if (combo == -1) alert("Error interpreting defuse order");
        queue_command(11,"*COMBO="+combo);
      }

      function updateAlarmDuration() {
        var newTime = parseInt($("#newAlarmDuration").val());
        if (newTime !== NaN) {
          if (newTime < 127 && newTime >= 0) queue_command(11,"*SIREN_T="+newTime);
          else alert("Specified time may be too extreme")
        }
        else alert("Error interpreting new alarm duration");
      }

      function updateAlarmDefuseDuration() {
        var newFactor = parseInt($("#newAlarmDefuseDuration").val());
        if (newFactor !== NaN) {
          if (newFactor < 1015 && newFactor > 0) queue_command(11,"*TFACTOR="+newFactor);
          else alert("Specified factor is too extreme")
        }
        else alert("Error interpreting new alarm defuse duration");
      }

      function updateHintGivenCost() {
        hintGivenCost = parseInt($("#hintGivenCost").val());
        actual_settings["Penalty Hint"] = hintGivenCost;
      }

      function updateAlarmTriggerCost() {
        alarmTriggerCost = parseInt($("#alarmTriggerCost").val());
        actual_settings["Penalty Alarm Trigger"] = alarmTriggerCost;
      }

      function set_led_progress(beep) {
        if (beep) {
          val = parseInt($("#ledProgress_beep").val());
          if (val !== NaN) {
            if (val >= 0 && val <= 145) queue_command(3, "*AUDIO_PROG=" + val) ;
            else alert("Progress must be a number between 0 and 145");
          }
          else alert("Error interpreting new progress");
        }
        else {
          val = parseInt($("#ledProgress_silent").val());
          if (val !== NaN) {
            if (val >= 0 && val < 145) queue_command(3, "*PROG=" + val) ;
            else alert("Progress must be a number between 0 and 145");
          }
          else alert("Error interpreting new progress");
        }

      }

      function set_led_brightness() {
        var brightness = parseInt($("#led_brightness").val())
        if (brightness !== NaN) {
          if (brightness >= 0 && brightness <= 255) queue_command(3, "*BRIGHT=" + brightness);
          else alert("Brightness out of range. Must be between 0 and 255");
        }
        else alert("Error interpreting brightness");
      }

      function set_led_transitions() {
        var value = parseInt($("#led_transitions").val())
        if (value !== NaN) {
          if (value >= 0 && value <= 255) queue_command(3, "*TRANS_BLINKS=" + value);
          else alert("The number of transition blinks must be between 0 and 255");
        }
        else alert("Error interpreting the number of transition blinks (must be a number between 0 and 255)");
      }

      function set_latch_delay() {
        val = parseInt($("#latch_delay").val());
        if (val !== NaN) {
          if (val >= 0 && val < 9999) queue_command(3, "*LATCH_MS=" + val) ;
          else alert("Delay must be a number between 0 and 9999");
        }
        else alert("Error interpreting new delay");
      }

      function set_latch_count() {
        val = parseInt($("#latch_count").val());
        if (val !== NaN) {
          if (val >= 0 && val < 9999) {
            latch_count = val;
            actual_settings["Latch Open Close Count"] = latch_count;
          }
          else alert("Count must be a number between 0 and 9999");
        }
        else alert("Error interpreting new count");
      }

      function set_latch_count_delay() {
        val = parseInt($("#latch_count_delay").val());
        if (val !== NaN) {
          if (val >= 0 && val < 9999) {
            latch_count_delay = val;
            actual_settings["Latch Open Close Count Delay"] = latch_count_delay;
          }
          else alert("Delay must be a number between 0 and 9999");
        }
        else alert("Error interpreting new delay");
      }

      function resetRoom() {
        $.getJSON("http://192.168.2.177?device=0&command=*RST");
      }
    </script>
  </body>
</html>